const http = require('http');
const fs = require('fs');
const path = require('path');

const formatBytes = (bytes) => {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return `${parseFloat((bytes / Math.pow(k, i)).toFixed(1))} ${sizes[i]}`;
};

const server = http.createServer((req, res) => {
    if (req.url === '/scan') {
        fs.readdir(__dirname, (err, files) => {
            if (err) {
                res.writeHead(500);
                res.end(JSON.stringify({ error: 'Erreur lors du scan du répertoire' }));
                return;
            }

            Promise.all(
                files.map(name => {
                    return new Promise((resolve, reject) => {
                        const filePath = path.join(__dirname, name);
                        fs.stat(filePath, (err, stats) => {
                            if (err) {
                                reject(err);
                                return;
                            }
                            resolve({
                                name,
                                isDirectory: stats.isDirectory(),
                                size: formatBytes(stats.size)
                            });
                        });
                    });
                })
            )
            .then(fileDetails => {
                res.writeHead(200, {
                    'Content-Type': 'application/json',
                    'Access-Control-Allow-Origin': '*'
                });
                res.end(JSON.stringify(fileDetails));
            })
            .catch(error => {
                res.writeHead(500);
                res.end(JSON.stringify({ error: 'Erreur lors du scan du répertoire' }));
            });
        });
    } else {
        fs.readFile('index.html', (err, content) => {
            if (err) {
                res.writeHead(500);
                res.end('Erreur lors du chargement de la page');
                return;
            }
            res.writeHead(200, { 'Content-Type': 'text/html' });
            res.end(content);
        });
    }
});

const PORT = 3000;
server.listen(PORT, () => {
    console.log(`Serveur démarré sur http://localhost:${PORT}`);
});
